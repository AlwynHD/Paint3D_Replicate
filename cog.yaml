# Configuration for Cog ⚙️
build:
  gpu: true
  system_packages:
    - "libgl1-mesa-glx"
    - "libglib2.0-0"
    - "git"
    - "python3-opencv"
    - "build-essential"
    - "cmake"
    - "zip"
    - "unzip"
    - "wget"
  python_version: "3.8"
  python_packages:
    # Build dependencies (must be first)
    - "pip>=24.0"
    - "packaging>=24.0"
    - "setuptools>=41.0.0"
    - "wheel"
  run:
    # Update pip first
    - pip install --upgrade pip
    # Install PyTorch and CUDA dependencies first
    - pip install --no-cache-dir torch==1.12.1+cu116 --extra-index-url https://download.pytorch.org/whl/cu116
    - pip install --no-cache-dir torchvision==0.13.1+cu116 --extra-index-url https://download.pytorch.org/whl/cu116
    # Install other dependencies in smaller chunks
    - pip install --no-cache-dir numpy==1.23.1 
    - pip install --no-cache-dir opencv-python==4.6.0.66
    - pip install --no-cache-dir imageio==2.9.0 imageio-ffmpeg==0.4.2
    - pip install --no-cache-dir pytorch-lightning==1.4.2 omegaconf==2.1.1 test-tube>=0.7.5
    - pip install --no-cache-dir einops==0.3.0 webdataset==0.2.5
    - pip install --no-cache-dir kornia==0.6 torchmetrics==0.6.0
    
    # Critical: Install the specific compatible versions
    - pip install --no-cache-dir huggingface_hub
    - pip install --no-cache-dir transformers==4.26.1
    
    # Installing diffusers version 0.18.2 as used in the original cog.yaml, but with the correct huggingface_hub version already installed
    - pip install --no-cache-dir diffusers==0.25.0 accelerate==0.29.2
    
    - pip install --no-cache-dir loguru==0.7.2 trimesh==3.20.2 
    - pip install --no-cache-dir xatlas==0.0.7
    - pip install --no-cache-dir open-clip-torch==2.0.2 invisible-watermark>=0.1.5 streamlit-drawable-canvas==0.8.0 albumentations==1.3.0
    # Install kaolin
    - pip install --no-cache-dir kaolin==0.13.0 -f https://nvidia-kaolin.s3.us-east-2.amazonaws.com/torch-1.12.1_cu116.html

    - echo 'from huggingface_hub import hf_hub_download, model_info' > /tmp/fixed_import.txt
    - sed -i 's/from huggingface_hub import cached_download, hf_hub_download, model_info/from huggingface_hub import hf_hub_download, model_info/g' /root/.pyenv/versions/3.8.20/lib/python3.8/site-packages/diffusers/utils/dynamic_modules_utils.py

predict: "predict.py:Predictor"
image: "r8.im/alwynhd/paint3d"